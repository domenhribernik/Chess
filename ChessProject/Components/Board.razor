@using ChessProject.PiecesData

@for (int i = 0; i < 8; i++) {
    int localI = i;
    <div class="row">
    @for (int j = 0; j < 8; j++) {
            int localJ = j;
            var pawn = blackPawns.FirstOrDefault(n => n.Column == j && n.Row == i);
            var rook = blackRooks.FirstOrDefault(n => n.Column == j && n.Row == i);
            var bishop = blackBishops.FirstOrDefault(n => n.Column == j && n.Row == i);
            var knight = blackKnights.FirstOrDefault(n => n.Column == j && n.Row == i);
            var queen = blackQueen.FirstOrDefault(n => n.Column == j && n.Row == i);
            var king = blackKing.FirstOrDefault(n => n.Column == j && n.Row == i);
            if (pawn == null) {
                pawn = whitePawns.FirstOrDefault(n => n.Column == j && n.Row == i);
            }
            if (rook == null) {
                rook = whiteRooks.FirstOrDefault(n => n.Column == j && n.Row == i);
            }
            if (bishop == null) {
                bishop = whiteBishops.FirstOrDefault(n => n.Column == j && n.Row == i);
            }
            if (knight == null) {
                knight = whiteKnights.FirstOrDefault(n => n.Column == j && n.Row == i);
            }
            if (queen == null) {
                queen = whiteQueen.FirstOrDefault(n => n.Column == j && n.Row == i);
            }
            if (king == null) {
                king = whiteKing.FirstOrDefault(n => n.Column == j && n.Row == i);
            }

            bool canMoveHere = cellsPossible.Contains((i, j));

            <div @onclick="() => MovePawn(localI, localJ)" class="cell @(canMoveHere ? "active" : "")">
                @if (pawn != null) {
                    <div @onclick="() => { PawnClicked(pawn); }"
                        class="pawn @pawn.Color @(pawn == activePawn ? "active" : "")">

                        @if (pawn.Color == "black") {
                            <img class="board-piece" src="/pictures/black_pawn.svg" />
                        }
                        else {
                            <img class="board-piece" src="/pictures/white_pawn.svg" />
                        }
                    </div>
                }
                @if (rook != null) {
                    if (rook.Color == "black") {
                        <img class="board-piece" src="/pictures/black_rook.svg" />
                    } else if (rook.Color == "white") {
                        <img class="board-piece" src="/pictures/white_rook.svg" />
                    }
                }
                @if (bishop != null) {
                    if (bishop.Color == "black") {
                        <img class="board-piece" src="/pictures/black_bishop.svg" />
                    } else if (bishop.Color == "white") {
                        <img class="board-piece" src="/pictures/white_bishop.svg" />
                    }
                }
                @if (knight != null) {
                    if (knight.Color == "black") {
                        <img class="board-piece" src="/pictures/black_knight.svg" />
                    } else if (knight.Color == "white") {
                        <img class="board-piece" src="/pictures/white_knight.svg" />
                    }
                }
                @if (queen != null) {
                    if (queen.Color == "black") {
                        <img class="board-piece" src="/pictures/black_queen.svg" />
                    } else if (queen.Color == "white") {
                        <img class="board-piece" src="/pictures/white_queen.svg" />
                    }
                }
                @if (king != null) {
                    if (king.Color == "black") {
                        <img class="board-piece" src="/pictures/black_king.svg" />
                    } else if (king.Color == "white") {
                        <img class="board-piece" src="/pictures/white_king.svg" />
                    }
                }
            </div>
    }
    </div>
}

@code {
    List<PawnData> whitePawns = new List<PawnData>();
    List<PawnData> blackPawns = new List<PawnData>();
    List<RookData> whiteRooks = new List<RookData>();
    List<RookData> blackRooks = new List<RookData>();
    List<BishopData> whiteBishops = new List<BishopData>();
    List<BishopData> blackBishops = new List<BishopData>();
    List<KnightData> whiteKnights = new List<KnightData>();
    List<KnightData> blackKnights = new List<KnightData>();
    List<QueenData> whiteQueen = new List<QueenData>();
    List<QueenData> blackQueen = new List<QueenData>();
    List<KingData> whiteKing = new List<KingData>();
    List<KingData> blackKing = new List<KingData>();
 
    string black = "black";
    string white = "white";
    bool whiteTurn = true;

    protected override void OnInitialized()
    {
        for (int i = 0; i < 8; i++)
        {
            blackPawns.Add(new PawnData
            {
                Color = "black",
                Column = i,
                Row = 1,
                Direction = PawnDirection.Down
                });
        }

        for (int i = 0; i < 8; i++)
        {
            blackPawns.Add(new PawnData
            {
                Color = "white",
                Column = i,
                Row = 6,
                Direction = PawnDirection.Up
            });
        }

        for (int i = 0; i < 8; i+=7)
        {
            blackRooks.Add(new RookData
            {
                Color = "black",
                Column = i,
                Row = 0,
                Direction = RookDirection.Straight
                });
        }

        for (int i = 0; i < 8; i+=7)
        {
            whiteRooks.Add(new RookData
            {
                Color = "white",
                Column = i,
                Row = 7,
                Direction = RookDirection.Straight
            });
        }

        for (int i = 1; i < 7; i+=5)
        {
            blackBishops.Add(new BishopData
            {
                Color = "black",
                Column = i,
                Row = 0,
                Direction = BishopDirection.Diagonally
                });
        }

        for (int i = 1; i < 7; i+=5)
        {
            whiteBishops.Add(new BishopData
            {
                Color = "white",
                Column = i,
                Row = 7,
                Direction = BishopDirection.Diagonally
            });
        }

        for (int i = 2; i < 6; i+=3)
        {
            blackKnights.Add(new KnightData
            {
                Color = "black",
                Column = i,
                Row = 0,
                Direction = KnightDirection.LShape
                });
        }

        for (int i = 2; i < 6; i+=3)
        {
            whiteKnights.Add(new KnightData
            {
                Color = "white",
                Column = i,
                Row = 7,
                Direction = KnightDirection.LShape
            });
        }

        whiteQueen.Add(new QueenData
        {
            Color = "black",
            Column = 3,
            Row = 0,
            Direction = QueenDirection.Any
        });

        blackQueen.Add(new QueenData
        {
            Color = "white",
            Column = 3,
            Row = 7,
            Direction = QueenDirection.Any
        });

        whiteKing.Add(new KingData
        {
            Color = "black",
            Column = 4,
            Row = 0,
            Direction = KingDirection.OneAny
        });

        blackKing.Add(new KingData
        {
            Color = "white",
            Column = 4,
            Row = 7,
            Direction = KingDirection.OneAny
        });
    }

    PawnData activePawn = null;

    List<(int row, int column)> cellsPossible = new();

    //preveri kam lahko gre
    void CheckDirectionsPawns() {
        cellsPossible.Clear();

        if (activePawn != null)
        {
            //poje
            if ((activePawn.Color == black) && (IfFigureExists(activePawn.Row + 1, activePawn.Column - 1)))
            {
                Console.WriteLine("je");
                var whitePawn = whitePawns.FirstOrDefault(n => n.Row == activePawn.Row + 1 && n.Column == activePawn.Column - 1);
                if (whitePawn != null)
                {
                    whitePawns.Remove(whitePawn);
                    Console.WriteLine("j2e");
                }
                AddIfFigureExists(activePawn.Row + 1, activePawn.Column - 1);
            }
            if ((activePawn.Color == black) && (IfFigureExists(activePawn.Row + 1, activePawn.Column + 1)))
            {
                Console.WriteLine("je");
                var whitePawn = whitePawns.FirstOrDefault(n => n.Row == activePawn.Row + 1 && n.Column == activePawn.Column + 1);
                if (whitePawn != null)
                {
                    whitePawns.Remove(whitePawn);
                    AddIfFigureExists(activePawn.Row + 1, activePawn.Column + 1);
                }
            }

            //1 polje naprej
            if (activePawn.Direction == PawnDirection.Down) {
                AddIfFigureExists(activePawn.Row + 1, activePawn.Column);
                var whitePawn = blackPawns.FirstOrDefault(n => n.Row == 6 && n.Column == 1);
                if (whitePawn != null)
                {
                    whitePawns.Remove(whitePawn);
                    Console.WriteLine("j2e");
                }
                else {
                    Console.WriteLine("niii");
                }
            }
            else if (activePawn.Direction == PawnDirection.Up)
            {
                AddIfFigureExists(activePawn.Row - 1, activePawn.Column);
            }

            //za 2 naprej na zacetku
            if ((activePawn.Row == 1) && (activePawn.Color == black) && (!IfFigureExists(2, activePawn.Column)))
            {
                AddIfFigureExists(3, activePawn.Column);
            }
            else if ((activePawn.Row == 6) && (activePawn.Color == white) && (!IfFigureExists(5, activePawn.Column)))
            {
                AddIfFigureExists(4, activePawn.Column);
            }


        }
    }

    bool IfFigureExists(int row, int column)
    {
        var blackPawn = blackPawns.FirstOrDefault(n => n.Column == column && n.Row == row);
        var whitePawn = whitePawns.FirstOrDefault(n => n.Column == column && n.Row == row);

        if ((blackPawn == null) && (whitePawn == null))
        {
            return false;
        }
        else {
            return true;
        }
    }

    void AddIfFigureExists(int row, int column) {

        if (!IfFigureExists(row, column)) {
            cellsPossible.Add((row, column));
            Console.Write(row);
            Console.Write(column);
            Console.Write("\n");
        }
    }

    //premika
    void MovePawn(int row, int column) {
        bool canMoveHere = cellsPossible.Contains((row, column));
        if (!canMoveHere) {
            return;
        }
        //premik
        activePawn.Column = column;
        activePawn.Row = row;

        activePawn = null;
        whiteTurn = !whiteTurn;
        CheckDirectionsPawns();
    }

    void PawnClicked(PawnData pawn) {
        if (whiteTurn && pawn.Color == black) {
            return;
        }
        if (!whiteTurn && pawn.Color == white) {
            return;
        }

        if (activePawn == pawn)
        {
            activePawn = null;
        }
        else
        {
            activePawn = pawn;
        }

        CheckDirectionsPawns();
    }

    void DeleteFigure() {

    }
}